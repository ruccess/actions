name: "Close PR on Failure"

on:
  pull_request:
    branches: ["dev"]
    types: [opened, synchronize, reopened]

jobs:
  check-and-build:
    env: 
      URL_PATTERN: https://well-check.atlassian.net
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'node'
          cache: 'npm'

      - name: Check commit messages
        id: check-commits
        run: |
          # 커밋 메시지 검사
          echo "COMMIT_MSG=$(git log --no-merges -1 --oneline)" >> "$GITHUB_OUTPUT"
          echo "KEYWORD=fix feat chore"

          echo ${{env.URL_PATTERN}}
          echo ${{github.event.commits}}
          echo "TEST"
          
          # 키워드 확인
          echo "STATUS_CHECK=fail" >> "$GITHUB_OUTPUT"
          for keyword in ${{steps.check-commits.outputs.KEYWORD}}; do
            if [[ ${{steps.check-commits.outputs.COMMIT_MSG}} =~ $keyword: ]]; then
              "STATUS_CHECK=true" >> "$GITHUB_OUTPUT"
              break
            fi
          done

          if [ ${{steps.check-commits.outputs.STATUS_CHECK}} != true ]; then
            echo "message=Missing required keywords ( ${KEYWORDS} )." >> "$GITHUB_ENV"
            echo "status=fail" >> "$GITHUB_ENV"
          else
            # URL 검사
            if ! [[ ${{steps.check-commits.outputs.COMMIT_MSG}} =~ $URL_PATTERN ]]; then
              echo "message=Commit message does not contain required URL." >> "$GITHUB_ENV"
              echo "status=fail" >> "$GITHUB_ENV"
            else
              echo "status=success" >> "$GITHUB_ENV"
            fi
          fi
        continue-on-error: true

      - name: Install dependencies
        if: env.status == 'success'
        run: npm install
        continue-on-error: true

      - name: Run lint
        if: env.status == 'success'
        run: npm run lint
        continue-on-error: true

      - name: Run tests
        if: env.status == 'success'
        run: npm test
        continue-on-error: true

      - name: Run build
        if: env.status == 'success'
        run: npm run build
        continue-on-error: true

      - name:  Leave comment on PR
        uses: peter-evans/create-or-update-comment@v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            This is a multi-line test comment
            "Failed at step ${{ env.step }}: ${{ env.message }}"
          reactions: '+1'

      - name: Close Pull
        if: env.status == 'fail' || failure()
        uses: peter-evans/close-pull@v3
        with:
          delete-branch: false
